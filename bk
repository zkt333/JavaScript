<%@taglib uri="http://java.sun.com/portlet_2_0" prefix="portlet"%>
<%@taglib uri="http://liferay.com/tld/aui" prefix="aui"%>
<%@taglib uri="http://liferay.com/tld/ui" prefix="liferay-ui"%>
<%@page import="java.io.Serializable"%>
<%@page import="javax.portlet.PortletSession"%>
<%@page import="com.liferay.portal.model.User"%>
<%@page import="com.liferay.portal.model.Organization"%>
<%@page import="com.liferay.portal.theme.ThemeDisplay"%>
<%@page import="java.util.*"%>
<%@page import="javax.portlet.PortletPreferences"%>
<%@page import="java.text.DateFormat"%>
<%@page import="java.text.SimpleDateFormat"%>
<%@page import="com.liferay.portlet.expando.service.ExpandoValueServiceUtil"%>
<%@page import="com.liferay.portal.service.OrganizationLocalServiceUtil"%>
<%@page import="com.liferay.portal.kernel.util.WebKeys"%>
<%@page import="com.liferay.portal.kernel.language.LanguageUtil"%>
<%@page import="com.liferay.portal.kernel.util.ParamUtil"%>
<%@page import="com.liferay.portal.util.PortalUtil"%>
<%@page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>

<%@ page import="java.util.Date" %>
<%@ page import="java.util.Calendar" %>
<portlet:defineObjects />

<%
ThemeDisplay themeDisplay = (ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
User user = themeDisplay.getUser();
String langId=LanguageUtil.getLanguageId(request);
boolean is_en_US=langId.equals("en_US");
boolean is_zh_CN=langId.equals("zh_CN");
boolean is_ja_JP=langId.equals("ja_JP");
long userId = user.getUserId();

java.util.Date date= new Date();
Calendar cal = Calendar.getInstance();
cal.setTime(date);
int month = cal.get(Calendar.MONTH);
int year=cal.get(Calendar.YEAR);

String namespace="_cashflow_WAR_LmUserProfileportlet_";
%>


<div class="<%=namespace%>cashflow">
	 <div class="header">
        <div style="position:absolute;width:100%;height:100%;z-index:10;background:black;opacity:0.5;">&nbsp;</div>

        <div class="header-text">
         <p><liferay-ui:message key="myProfile.cashflow.header"/></p>
        </div>
    </div>
	 
	<div class="container">
	    <div id="<%=namespace%>noaccount">
	                     
	                          <div class="no-icon-account">
	                          </div>
	                          <div class="no-res">
	                               <p><liferay-ui:message key="myProfile.noresult"/></p>
	                          </div>
	                   
	    </div>         
	            
	    <div class="cashflow-table" id="<%=namespace%>account">
	     			<div class="row-fluid" style="float:right">
			             <!-- Selectors -->
			             <aui:fieldset>
			                  
			                   <aui:col span="5">
			                        <%--<%=LanguageUtil.get(themeDisplay.getLocale(), "lm.cashflow.label.account")%> --%>
			                        <aui:select id="accountSelect" name="account" label='<%=LanguageUtil.get(themeDisplay.getLocale(), "myProfile.cashflow.account")%>'>
			                        </aui:select>
			                    </aui:col>
			                    <aui:col span="2"></aui:col> 
			                    <aui:col span="5">
			                        <%--<%=LanguageUtil.get(themeDisplay.getLocale(), "lm.cashflow.label.account")%> --%>
			                        <aui:select id="reportPeriodSelect" name="reportPeriod" label='<%=LanguageUtil.get(themeDisplay.getLocale(), "myProfile.cashflow.reportPeriod")%>'>
			                          <option value="0"><liferay-ui:message key="myProfile.cashflow.currentmonth"/></option>
                                      <option value="2"><liferay-ui:message key="myProfile.cashflow.past3months"/></option>
                                      <option value="5"><liferay-ui:message key="myProfile.cashflow.past6months"/></option>
                                      <option value="11"><liferay-ui:message key="myProfile.cashflow.past1year"/></option>
                                      <option value="all"><liferay-ui:message key="myProfile.cashflow.morethan1year"/></option>
			                        </aui:select>
			                    </aui:col>
			                                              
			             </aui:fieldset>
	    			</div>              
	                 <div class="noneres" id="<%=namespace%>nores">
	                     
	                          <div class="no-icon">
	                          </div>
	                          <div class="no-res">
	                               <p><liferay-ui:message key="myProfile.noresult"/></p>
	                          </div>
	                   
	                 </div>
	                  <!-- Balance Sheet -->
	                 <div class="row-fluid" id="<%=namespace%>res">
			               <div class="row-fluid">
			                    <div class="mytable">
				                    <table id="cashflowrecords" class="table table-striped table-hover table-responsive" style="width:100%;">
				                        <thead>
								            <tr id="<%=namespace%>head" style="display:none">
								                <th><liferay-ui:message key="myProfile.cashflow.date"/></th>								                
								                <th><liferay-ui:message key="myProfile.cashflow.description"/></th>
								                <%-- <th class="<%=namespace%>vip"><liferay-ui:message key="myProfile.cashflow.debit"/></th>
								                <th class="<%=namespace%>vip"><liferay-ui:message key="myProfile.cashflow.credit"/></th> --%>
								                
								                <th></th>
							
								            </tr>
								        </thead>
				                    </table>
				                 </div>
			                     <div id="cashflowdialog" title="Basic dialog" style="display:none">
                                   <div id="cashflowdetail"></div>  
                                 </div>       
			               </div>
			          </div>
	            </div> 
		</div>
</div>

<div style="display:none">
<div id="date"><liferay-ui:message key="myProfile.cashflow.date"/></div>
<div id="transactionType"><liferay-ui:message key="myProfile.cashflow.transactionType"/></div>
<div id="description"><liferay-ui:message key="myProfile.cashflow.description"/></div>
<div id="debit"><liferay-ui:message key="myProfile.cashflow.debit"/></div>
<div id="credit"><liferay-ui:message key="myProfile.cashflow.credit"/></div>
<div id="balance"><liferay-ui:message key="myProfile.cashflow.balance"/></div>
<div id="details"><liferay-ui:message key="myProfile.cashflow.details"/></div>	
</div>

<aui:script use="array-extras, node, event">
var month=<%=month%>;
var year=<%=year%>;
var periods=[0, 3, 6, 12];

var reportPeriodSelect = A.one('#<portlet:namespace/>reportPeriodSelect');

//Get Translation
var date = $('#date').html();
var transactionType = $('#transactionType').html();
var description = $('#description').html();
var debit = $('#debit').html();
var credit = $('#credit').html();
var balance = $('#balance').html();
var details = $('#details').html();
var time = new Date();
var month = time.getMonth()+1;
//console.log(month);
function generateTimeSelection(){
	 	// get report period selector
    	
    	accountSelect.empty();
}
function monthdiff(d1,d2){
	var month1;
	var month2;
	var months;
	month1 = (d1.getFullYear() - d2.getFullYear())*12;
	month2 = d1.getMonth() - d2.getMonth();
	month = month1 + month2;
	return month;
	
}
// change string date to Date
function getdate(date){
	/* var t = date.substring(0,10);
 	var t1 = date.split('-'); */
	var mydate = new Date(Date.parse(date)); 
	return mydate;
}

     if (Liferay.ThemeDisplay.isSignedIn()) {
        
        
        var nores=document.getElementById('<%=namespace%>nores');
        var res=document.getElementById('<%=namespace%>res');
        var noaccount=document.getElementById('<%=namespace%>noaccount');
        var account=document.getElementById('<%=namespace%>account');
        var head = document.getElementById('<%=namespace%>head');
        
        // get account selector
        var accountSelect = A.one('#<portlet:namespace/>accountSelect');
        accountSelect.empty();
        
        
        //var userId = Liferay.ThemeDisplay.getUserId();
        var userId=<%=userId%>;
        
       
        Liferay.Service('/LmAccountServices-portlet.account/get-account', {
            userId : userId,
            localeCd: "<%=langId%>"
        }, function(response) {
        	 accounts = [];
        	 accountnames=[];
        	//console.log(response.value[0]);
        	for(var i=0;i<response.value.length;i++){
        		accounts.push(response.value[i].accountId);
        	}
        	for(var i=0;i<response.value.length;i++){
        		accountnames.push(response.value[i].accountName);
        	}
            //console.log(accounts);
            
            var numOfAccounts = accounts.length;            
            if (numOfAccounts > 0) {
            	account.style.display='block';
            	noaccount.style.display='none';
             // populate accounts
                for (var i = accountnames.length - 1; i >= 0; i--) {
                    var option = A.Node.create('<option value=\"' + accountnames[i] + '\" selected>' + accountnames[i] + '</option>');
                    accountSelect.append(option);
                }
                
                // populate time periods
 
                
                // render transactions
                var accountId = accounts[0];
 
                
                Liferay.Service('/LmBusinessServices-portlet.task/get-cash-flow', {
                    accountId : accountId,
                    localeCd : "<%=langId%>",
                }, function(response) {
                	//console.log(response);
                    
                    if(response.status.code=="200"){
                    transactions = response.value;
                    
                    //console.log(transactions);
                    //console.log(transactions.length);
                    //console.log(transactions);
                    //console.log(transactions[0].transactionDate[5]);
                   /*  var cha = parseInt(time)-parseInt(transactions[0].transactionDate);
                    console.log(transactions[0].transactionDate.getMonth()); */
                    var tras = [];
                    for(var i=0;i<transactions.length;i++){
                    	
                    	tras.push(getdate(transactions[i].date));
                    }
                    //console.log(tras);
                    var showdata = [];
                    for(var i=0;i<tras.length;i++){
                    	if(monthdiff(time,tras[i])<1){
                    		showdata.push(transactions[i]);
                    	}
                    }
                    //console.log(showdata);
                    
                  
                    //console.log(transactions);
                    if (showdata.length > 0) {
                        // append content to table
                        //refreshTable(transactions);
                    	generateTable(showdata);
                    	head.style.display='table-row';
                    } else {
                    	res.style.display='none';
                    	nores.style.display='block';
                    }  
                    //console.log(transactions);
                    //generateTable(transactions);
                    }else{
                    	res.style.display='none';
                    	nores.style.display='block';
                    }
                });  
                } else {
            	account.style.display='none';
            	noaccount.style.display='block';
            }   
            
        });
        
        A.one("#<portlet:namespace/>accountSelect").on('change', function() {
        	//transactions = [];
            var accountname = (accountSelect.get('options').item(accountSelect.get('selectedIndex')).get('value'));
            var timePeriod = (reportPeriodSelect.get('options').item(reportPeriodSelect.get('selectedIndex')).get('value'));
            var accountId = accounts[accountnames.indexOf(accountname)];
            
            Liferay.Service('/LmBusinessServices-portlet.task/get-cash-flow', {
                accountId : accountId,
                localeCd : "<%=langId%>",
            }, function(response) {
            	console.log(response);
            	 if(response.status.code=="200"){
                 transactions = response.value;
                
                //console.log(transactions);
                //console.log(transactions.length);
                //console.log(transactions[0].updateTime);
                var tras = [];
                
                for(var i=0;i<transactions.length;i++){
                	
                	tras.push(getdate(transactions[i].date));
                }
                var showdata = [];
                if(timePeriod=='all'){
                	//console.log('yesall');
                	if(transactions.length>0){
                		nores.style.display='none';
                        res.style.display='block';
                		//console.log('trans');
                		//console.log(transactions);
                		generateTable(transactions);
                		//console.log('trans');
                		head.style.display='table-row';
                	}else{
                		res.style.display='none';
                    	nores.style.display='block';
                	}
                }
                else{
                for(var i=0;i<tras.length;i++){
                	if(monthdiff(time,tras[i])<=timePeriod){
                		showdata.push(transactions[i]);
                	}
                }
                 if (showdata.length > 0) {
                	// append content to table
                    nores.style.display='none';
                    res.style.display='block';
                    //refreshTable(transactions);
                    generateTable(showdata);
                    head.style.display='table-row';
                } else {
                	res.style.display='none';
                	nores.style.display='block';
                } 
                //console.log(transactions);
                //generateTable(transactions);
               
                }
            }else{
            	//console.log(transactions);
            	transactions = [];
            	res.style.display='none';
            	nores.style.display='block';
            }
            });
            
        });
        
        A.one("#<portlet:namespace/>reportPeriodSelect").on('change', function() {
             //console.log(transactions);
            //var accountId = (accountSelect.get('options').item(accountSelect.get('selectedIndex')).get('value'));
            var timePeriod = (reportPeriodSelect.get('options').item(reportPeriodSelect.get('selectedIndex')).get('value'));        

            if(typeof(transactions)!='undefined'){
            	if (transactions.length!=0){
            var tras = [];
            for(var i=0;i<transactions.length;i++){
            	
            	tras.push(getdate(transactions[i].date));
            }

            if(timePeriod=='all'){

            	if(transactions.length>0){
            		nores.style.display='none';
                    res.style.display='block';
 
            		generateTable(transactions);

            		head.style.display='table-row';
            	}else{
            		res.style.display='none';
                	nores.style.display='block';
            	}
            }else{
            var showdata = [];
            for(var i=0;i<tras.length;i++){
            	if(monthdiff(time,tras[i])<=timePeriod){
            		showdata.push(transactions[i]);
            	}
            }

                
                 if (showdata.length > 0) {
                	 nores.style.display='none';
                     res.style.display='block';
                     //refreshTable(transactions);
                     generateTable(showdata);
                     head.style.display='table-row';
                     
                } else {
                	res.style.display='none';
                	nores.style.display='block';
                }
            }
            }
            }
        });

     function generateTable(dataSet){
	      	if ( $.fn.DataTable.isDataTable('#cashflowrecords') ) {
	    		  $('#cashflowrecords').DataTable().destroy();
	    		  
			    	//console.log(dataSet);
	    		}
	      	
    	 console.log(dataSet);
         var tem = [];
         for(var j=0;j<dataSet.length;j++){
        	 tem.push(getCashFlowInfor(dataSet[j]));
         }
         console.log(tem);
         var data =[];
         for(var i=0;i<tem.length;i++){
        	 var arr = Object.keys(tem[i]).map(function (key) { return tem[i][key]; });
        	 data.push(arr);
         }
         console.log(data);
    	 //var index;
    	 if(<%=is_zh_CN%>){
         var table = $('#cashflowrecords').DataTable({
             // rowReorder: {
             //     selector: 'td:nth-child(2)'
             //     // selector:'tr'
             // },
             //paging: false,
             destroy: true,
             //searching: false,
             responsive: true,
             "data":data,
             "oLanguage" : {
                 "sLengthMenu": "每页显示 _MENU_ 条记录",
                 "sZeroRecords": "抱歉， 没有找到",
                 "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
                 "sInfoEmpty": "没有数据",
                 "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
                 "sZeroRecords": "没有检索到数据",
                  "sSearch": "名称:",
                 "oPaginate": {
                 "sFirst": "首页",
                 "sPrevious": "前一页",
                 "sNext": "后一页",
                 "sLast": "尾页"
                 }
                 },
             "columnDefs": [ {
                 "targets": -1,
                 "data": null,
                 // "defaultContent": "<button>click</button>"
                 "defaultContent": "<div><a href='#' class='view'>"+'<liferay-ui:message key="myProfile.cashflow.details"/>'+"</a></div>"
               }
                 ,{
                     "targets": [2],
                     "visible": true,
                     "searchable": false
                 }   
                ]
         } )
    	 };
    	 if(<%=is_en_US%>){
    		 var table = $('#cashflowrecords').DataTable({
                 // rowReorder: {
                 //     selector: 'td:nth-child(2)'
                 //     // selector:'tr'
                 // },
                 //paging: false,
                 destroy: true,
                 //searching: false,
                 responsive: true,
                 "data":data,
                 "columnDefs": [ {
                     "targets": -1,
                     "data": null,
                     // "defaultContent": "<button>click</button>"
                     "defaultContent": "<div><a href='#' class='view'>"+'<liferay-ui:message key="myProfile.cashflow.details"/>'+"</a></div>"
                   }
                     ,{
                         "targets": [2],
                         "visible": true,
                         "searchable": false
                     }   
                    ]
             } )
    	 };
    	 if(<%=is_ja_JP%>){
             var table = $('#cashflowrecords').DataTable({
                 // rowReorder: {
                 //     selector: 'td:nth-child(2)'
                 //     // selector:'tr'
                 // },
                 //paging: false,
                 destroy: true,
                 //searching: false,
                 responsive: true,
                 "data":data,
                 "oLanguage" : {
                	 "sLengthMenu": "各ページ _MENU_ 個記録",
                     "sZeroRecords": "すみません、見つかりません。",
                     "sInfo": " _START_ から _END_ まで総計 _TOTAL_ 個記録",
                     "sInfoEmpty": "記録はありません",
                     "sInfoFiltered": "( _MAX_ 個記録から捜索)",
                     "sZeroRecords": "記録が見つかりません",
                      "sSearch": "名称：",
                     "oPaginate": {
                     "sFirst": "先頭ページ",
                     "sPrevious": "前のページ",
                     "sNext": "次のページ",
                     "sLast": "最終ページ"
                     }
                     },
                 "columnDefs": [ {
                     "targets": -1,
                     "data": null,
                     // "defaultContent": "<button>click</button>"
                     "defaultContent": "<div><a href='#' class='view'>"+'<liferay-ui:message key="myProfile.cashflow.details"/>'+"</a></div>"
                   }
                     ,{
                         "targets": [2],
                         "visible": true,
                         "searchable": false
                     }   
                    ]
             } )
        	 };
         
         // Set View Details Link
         $('#cashflowrecords tbody').off( 'click.rowClick' ).on( 'click.rowClick', '.view', function (event) {
        	 
             var newindex=table.row($(this).closest('tr')).index();
             var tr = $(this).closest("tr");
             var rowindex = tr.index();
             console.log(data[rowindex]);
             //console.log(newindex);
             if(newindex==undefined){
            	 newindex=table.row($(this).closest('tr').prev()).index();
             }
             
             window.index=newindex;
             
             var data1=data[window.index];
               //console.log(data);
             
      	      if($(window).width()>600){
            	  var screenWidth = '500px';
              }else{
            	  var screenWidth = $(window).width()-30+'px';
              }
      	    event.preventDefault();
      	    //console.log(data);
      	    $('#cashflowdialog').dialog({
     	        title: details,
     	        modal: true,
     	        width: screenWidth,
     	        height:'auto',
     	        resizable:false,
     	        position: { my: "center", at: "center", of: window },
     	        buttons: [

     			    {
     			        text: '<liferay-ui:message key="myProfile.cashflow.cancelorder"/>',
     			        click: function() { alert('Cancel Clicked')}
     			    }
     			  ],
     	        open: function(){
     	        	console.log(data);
     	        	$('#cashflowdetail').html('<div class="cashflowRecord"><table>\
         	                   <tr><td>'+date+':</td><td>'+data[rowindex][0]+'</td></tr>\
         	                   <tr><td>'+description+':</td><td>'+data[rowindex][1]+'</tr>\
         	                   </table></div>')
     	      },
     	      close:function(event,ui){
     	    	  $('#cashflowdialog').dialog("destroy");
     	      }
           }); 
      	     $(".ui-dialog-titlebar").css("background-color", "#61cc61");
      	     $(".ui-dialog-title").css("color", "white");
      	     $(".ui-dialog").css("position", "center");
         });
    	      
     }
     }
   
    
   
</aui:script>








